import findUp from 'find-up'
import path from 'path'
import chokidar from 'chokidar'
import { createTypesFile } from './generate'

export async function createAutoGeneratedCode({
  isWatchMode,
  skipCache,
}: {
  isWatchMode: boolean
  skipCache: boolean
}) {
  const repoPath = path.dirname(findUp.sync('yarn.lock', { cwd: __dirname })!)

  let taskId = 0
  let isRunning = false
  let shouldRunAgain = false

  async function run() {
    const runTask = () =>
      createTypesFile({
        skipCache,
        repoPath,
        taskId: taskId++,
      })

    if (isRunning) {
      shouldRunAgain = true
      return
    }
    isRunning = true

    if (isWatchMode) {
      console.clear()
    }
    await runTask()

    if (shouldRunAgain) {
      shouldRunAgain = false

      if (isWatchMode) {
        console.clear()
      }
      await runTask()
    }

    isRunning = false
  }

  run()

  if (isWatchMode) {
    chokidar
      .watch([
        path.join(repoPath, 'packages', 'contracts-deploy', 'src', 'deploy'),
        path.join(repoPath, 'packages', 'auto-generated-code', 'src', 'backend-swaggers'),
        path.join(repoPath, 'packages', 'auto-generated-code', 'src', 'git-contract-types', 'factories'),
      ])
      .on('all', () => run())
  }
}
